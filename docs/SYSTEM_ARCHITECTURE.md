# System Architecture - Wheelchair Transportation Platform

> **Version:** 1.0
> **Last Updated:** January 2026
> **Purpose:** Visual diagrams showing system structure and data flow

---

## Table of Contents

1. [High-Level Architecture](#1-high-level-architecture)
2. [Data Flow Diagrams](#2-data-flow-diagrams)
3. [Component Architecture](#3-component-architecture)
4. [Database Schema Diagram](#4-database-schema-diagram)
5. [Integration Architecture](#5-integration-architecture)
6. [Real-Time Architecture](#6-real-time-architecture)
7. [Security Architecture](#7-security-architecture)

---

## 1. High-Level Architecture

### 1.1 System Overview

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                              USERS                                           │
├─────────────┬─────────────┬─────────────┬─────────────┬─────────────────────┤
│ Dispatchers │   Drivers   │  Patients   │  Facilities │   Admin/Ops         │
│   (Web)     │ (Mobile/PWA)│  (Web/SMS)  │   (Web)     │    (Web)            │
└──────┬──────┴──────┬──────┴──────┬──────┴──────┬──────┴──────────┬──────────┘
       │             │             │             │                  │
       └─────────────┴─────────────┴─────────────┴──────────────────┘
                                   │
                    ┌──────────────▼──────────────┐
                    │      LOAD BALANCER          │
                    │    (Vercel Edge Network)    │
                    └──────────────┬──────────────┘
                                   │
       ┌───────────────────────────┼───────────────────────────┐
       │                           │                           │
┌──────▼──────┐           ┌────────▼────────┐          ┌───────▼───────┐
│   Next.js   │           │   WebSocket     │          │    Cron       │
│   App       │           │   Server        │          │    Worker     │
│  (Vercel)   │           │  (Socket.io)    │          │  (Background) │
└──────┬──────┘           └────────┬────────┘          └───────┬───────┘
       │                           │                           │
       └───────────────────────────┼───────────────────────────┘
                                   │
                    ┌──────────────▼──────────────┐
                    │       DATA LAYER            │
                    ├─────────────────────────────┤
                    │  PostgreSQL │ Redis │ S3    │
                    └──────────────┬──────────────┘
                                   │
       ┌───────────────────────────┼───────────────────────────┐
       │              │            │           │               │
┌──────▼──────┐ ┌─────▼────┐ ┌─────▼────┐ ┌───▼────┐ ┌────────▼────────┐
│   Stripe    │ │  Twilio  │ │ SendGrid │ │ Google │ │   QuickBooks    │
│  Payments   │ │   SMS    │ │  Email   │ │  Maps  │ │   Accounting    │
└─────────────┘ └──────────┘ └──────────┘ └────────┘ └─────────────────┘
```

### 1.2 Request Flow

```
┌──────────┐     ┌─────────┐     ┌──────────┐     ┌──────────┐     ┌──────────┐
│  Client  │────▶│  Edge   │────▶│   API    │────▶│  Service │────▶│ Database │
│  (Web)   │     │ (CDN)   │     │  Route   │     │  Layer   │     │  (PG)    │
└──────────┘     └─────────┘     └──────────┘     └──────────┘     └──────────┘
     │                                │                │
     │           WebSocket            │                │
     └───────────────────────────────▶│                │
                                      ▼                │
                              ┌──────────────┐         │
                              │    Redis     │◀────────┘
                              │  (Pub/Sub)   │
                              └──────────────┘
```

---

## 2. Data Flow Diagrams

### 2.1 Trip Booking Flow

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                           TRIP BOOKING FLOW                                  │
└─────────────────────────────────────────────────────────────────────────────┘

┌─────────┐                                                        ┌─────────┐
│ Patient │                                                        │  Driver │
│   or    │                                                        │         │
│Dispatch │                                                        │         │
└────┬────┘                                                        └────▲────┘
     │                                                                  │
     │ 1. Enter Booking Details                                         │
     ▼                                                                  │
┌─────────────┐     ┌─────────────┐     ┌─────────────┐                │
│  Address    │────▶│   Google    │────▶│  Validate   │                │
│  Input      │     │   Places    │     │  Service    │                │
│             │     │   API       │     │  Area       │                │
└─────────────┘     └─────────────┘     └──────┬──────┘                │
                                               │                        │
     ┌─────────────────────────────────────────┘                        │
     │                                                                  │
     ▼                                                                  │
┌─────────────┐     ┌─────────────┐     ┌─────────────┐                │
│  Calculate  │────▶│   Check     │────▶│  Generate   │                │
│  Distance   │     │   Pricing   │     │   Quote     │                │
│  & ETA      │     │   Rules     │     │   (30 min)  │                │
└─────────────┘     └─────────────┘     └──────┬──────┘                │
                                               │                        │
     ┌─────────────────────────────────────────┘                        │
     │                                                                  │
     ▼                                                                  │
┌─────────────┐     ┌─────────────┐     ┌─────────────┐                │
│  Collect    │────▶│   Stripe    │────▶│  Create     │                │
│  Payment    │     │   Auth      │     │   Trip      │                │
│  Info       │     │             │     │   Record    │                │
└─────────────┘     └─────────────┘     └──────┬──────┘                │
                                               │                        │
     ┌─────────────────────────────────────────┘                        │
     │                                                                  │
     ▼                                                                  │
┌─────────────┐     ┌─────────────┐     ┌─────────────┐                │
│  Check      │────▶│  Auto or    │────▶│  Notify     │────────────────┘
│  Driver     │     │  Manual     │     │  Driver &   │
│  Avail.     │     │  Assign     │     │  Patient    │
└─────────────┘     └─────────────┘     └─────────────┘
                                               │
                                               ▼
                                        ┌─────────────┐
                                        │   SMS via   │
                                        │   Twilio    │
                                        └─────────────┘
```

### 2.2 Trip Execution Flow

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                          TRIP EXECUTION FLOW                                 │
└─────────────────────────────────────────────────────────────────────────────┘

    DRIVER APP                    SERVER                      PATIENT/DISPATCH
    ──────────                    ──────                      ────────────────
         │                           │                              │
         │     Start Shift           │                              │
         ├──────────────────────────▶│                              │
         │                           │                              │
         │   ◀── Assigned Trips ─────│                              │
         │                           │                              │
         │   Start Trip              │                              │
         ├──────────────────────────▶│  ─── Trip Started SMS ──────▶│
         │                           │                              │
    ┌────┴────┐                      │                              │
    │ GPS     │  Location Updates    │                              │
    │ Every   ├─────────────────────▶│  ─── ETA Updates (WS) ──────▶│
    │ 10 sec  │                      │                              │
    └────┬────┘                      │                              │
         │                           │                              │
         │   Arrived at Pickup       │                              │
         ├──────────────────────────▶│  ─── Driver Arrived SMS ────▶│
         │                           │                              │
         │   Patient Picked Up       │                              │
         ├──────────────────────────▶│  ─── In Progress (WS) ──────▶│
         │                           │                              │
         │   Location Updates        │                              │
         ├──────────────────────────▶│  ─── Live Tracking (WS) ────▶│
         │                           │                              │
         │   Arrived at Dropoff      │                              │
         ├──────────────────────────▶│  ─── Arriving Soon (WS) ────▶│
         │                           │                              │
         │   Complete Trip           │                              │
         ├──────────────────────────▶│                              │
         │                           │                              │
         │                           │  ─── Trip Complete SMS ─────▶│
         │                           │                              │
         │                           │  ──▶ Capture Payment         │
         │                           │      (Stripe)                │
         │                           │                              │
         │                           │  ──▶ Send Receipt            │
         │                           │                              │
```

### 2.3 Payment Flow

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                            PAYMENT FLOW                                      │
└─────────────────────────────────────────────────────────────────────────────┘

    INDIVIDUAL PAYMENTS                    FACILITY INVOICING
    ───────────────────                    ─────────────────────

┌───────────┐                           ┌───────────┐
│  Booking  │                           │  Trip     │
│  Created  │                           │ Completed │
└─────┬─────┘                           └─────┬─────┘
      │                                       │
      ▼                                       ▼
┌───────────────┐                      ┌────────────────┐
│ Create Stripe │                      │ Add to Monthly │
│ PaymentIntent │                      │ Invoice Queue  │
│ (Authorize)   │                      └───────┬────────┘
└───────┬───────┘                              │
        │                                      │
        ▼                                      ▼
┌───────────────┐                      ┌────────────────┐
│ Trip Executed │                      │ End of Month   │
└───────┬───────┘                      │ Cron Job       │
        │                              └───────┬────────┘
        ▼                                      │
┌───────────────┐                              ▼
│ Trip Complete │                      ┌────────────────┐
└───────┬───────┘                      │ Generate       │
        │                              │ Invoice PDF    │
        ▼                              └───────┬────────┘
┌───────────────┐                              │
│ Capture       │                              ▼
│ Payment       │                      ┌────────────────┐
└───────┬───────┘                      │ Sync to        │
        │                              │ QuickBooks     │
        ▼                              └───────┬────────┘
┌───────────────┐                              │
│ Send Receipt  │                              ▼
│ (Email/SMS)   │                      ┌────────────────┐
└───────────────┘                      │ Email Invoice  │
                                       │ to Facility    │
                                       └───────┬────────┘
                                               │
                                               ▼
                                       ┌────────────────┐
                                       │ Track Payment  │
                                       │ (Net 30)       │
                                       └────────────────┘
```

### 2.4 Driver Payout Flow

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                          DRIVER PAYOUT FLOW                                  │
└─────────────────────────────────────────────────────────────────────────────┘

┌───────────────┐     ┌───────────────┐     ┌───────────────┐
│ Trip          │────▶│ Calculate     │────▶│ Record        │
│ Completed     │     │ Driver Share  │     │ Earning       │
└───────────────┘     └───────────────┘     └───────┬───────┘
                                                    │
                                                    ▼
                                            ┌───────────────┐
                                            │ Weekly Payout │
                                            │ Cron Job      │
                                            │ (Sunday 11PM) │
                                            └───────┬───────┘
                                                    │
        ┌───────────────────────────────────────────┼───────────────────┐
        │                                           │                   │
        ▼                                           ▼                   ▼
┌───────────────┐                          ┌───────────────┐    ┌──────────────┐
│ Calculate     │                          │ Aggregate     │    │ Deduct       │
│ Trip          │                          │ Tips &        │    │ Any          │
│ Earnings      │                          │ Bonuses       │    │ Deductions   │
└───────┬───────┘                          └───────┬───────┘    └──────┬───────┘
        │                                          │                   │
        └──────────────────────────────────────────┼───────────────────┘
                                                   │
                                                   ▼
                                          ┌───────────────┐
                                          │ Create Stripe │
                                          │ Connect       │
                                          │ Transfer      │
                                          └───────┬───────┘
                                                  │
                                                  ▼
                                          ┌───────────────┐
                                          │ Driver Bank   │
                                          │ Account       │
                                          │ (2-3 days)    │
                                          └───────────────┘
```

---

## 3. Component Architecture

### 3.1 Frontend Component Hierarchy

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                         FRONTEND ARCHITECTURE                                │
└─────────────────────────────────────────────────────────────────────────────┘

                              ┌─────────────┐
                              │    App      │
                              │   Layout    │
                              └──────┬──────┘
                                     │
          ┌──────────────────────────┼──────────────────────────┐
          │                          │                          │
    ┌─────▼─────┐             ┌──────▼──────┐            ┌──────▼──────┐
    │   Auth    │             │  Dashboard  │            │   Public    │
    │  Layout   │             │   Layout    │            │   Layout    │
    └─────┬─────┘             └──────┬──────┘            └──────┬──────┘
          │                          │                          │
    ┌─────┴─────┐       ┌────────────┼────────────┐      ┌──────┴──────┐
    │           │       │            │            │      │             │
┌───▼───┐  ┌────▼────┐  │     ┌──────▼──────┐    │   ┌──▼───┐    ┌────▼────┐
│ Login │  │Register │  │     │   Sidebar   │    │   │ Home │    │Services │
└───────┘  └─────────┘  │     └──────┬──────┘    │   └──────┘    └─────────┘
                        │            │           │
           ┌────────────┼────────────┼───────────┼────────────┐
           │            │            │           │            │
     ┌─────▼─────┐ ┌────▼────┐ ┌─────▼─────┐ ┌───▼───┐ ┌──────▼──────┐
     │ Dispatch  │ │  Driver │ │   Admin   │ │ Ops   │ │  Facility   │
     │  Portal   │ │  Portal │ │  Portal   │ │ Portal│ │   Portal    │
     └─────┬─────┘ └────┬────┘ └─────┬─────┘ └───┬───┘ └──────┬──────┘
           │            │            │           │            │
     ┌─────┴─────┐ ┌────┴────┐ ┌─────┴─────┐    │     ┌──────┴──────┐
     │           │ │         │ │           │    │     │             │
   ┌─▼──┐ ┌──────▼┐│ ┌───────▼┐│ ┌─────────▼┐ ┌─▼───┐ │ ┌───────────▼┐
   │Dash│ │Booking││ │Schedule││ │  Users   │ │Live │ │ │  Standing  │
   │    │ │ Form  ││ │        ││ │          │ │ Map │ │ │   Orders   │
   └────┘ └───────┘│ └────────┘│ └──────────┘ └─────┘ │ └────────────┘
                   │           │                      │
              ┌────▼────┐ ┌────▼────┐           ┌─────▼─────┐
              │  Rides  │ │ Reports │           │  Patients │
              │  List   │ │         │           │           │
              └─────────┘ └─────────┘           └───────────┘
```

### 3.2 API Layer Architecture

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                           API ARCHITECTURE                                   │
└─────────────────────────────────────────────────────────────────────────────┘

                           ┌─────────────────┐
                           │   API Gateway   │
                           │ (Next.js Routes)│
                           └────────┬────────┘
                                    │
            ┌───────────────────────┼───────────────────────┐
            │                       │                       │
      ┌─────▼─────┐          ┌──────▼──────┐         ┌──────▼──────┐
      │ Middleware│          │  Middleware │         │  Middleware │
      │  (Auth)   │          │   (Rate)    │         │ (Validate)  │
      └─────┬─────┘          └──────┬──────┘         └──────┬──────┘
            │                       │                       │
            └───────────────────────┼───────────────────────┘
                                    │
         ┌──────────────────────────┼──────────────────────────┐
         │                          │                          │
   ┌─────▼─────┐            ┌───────▼───────┐          ┌───────▼───────┐
   │   Trips   │            │    Drivers    │          │   Patients    │
   │  Service  │            │    Service    │          │   Service     │
   └─────┬─────┘            └───────┬───────┘          └───────┬───────┘
         │                          │                          │
   ┌─────▼─────┐            ┌───────▼───────┐          ┌───────▼───────┐
   │  Payments │            │   Vehicles    │          │  Facilities   │
   │  Service  │            │   Service     │          │   Service     │
   └─────┬─────┘            └───────┬───────┘          └───────┬───────┘
         │                          │                          │
         └──────────────────────────┼──────────────────────────┘
                                    │
                           ┌────────▼────────┐
                           │    Prisma ORM   │
                           └────────┬────────┘
                                    │
                    ┌───────────────┼───────────────┐
                    │               │               │
              ┌─────▼─────┐  ┌──────▼──────┐ ┌──────▼──────┐
              │PostgreSQL │  │    Redis    │ │     S3      │
              └───────────┘  └─────────────┘ └─────────────┘
```

---

## 4. Database Schema Diagram

### 4.1 Core Entities

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                        CORE DATABASE SCHEMA                                  │
└─────────────────────────────────────────────────────────────────────────────┘

┌──────────────┐       ┌──────────────┐       ┌──────────────┐
│     USER     │       │   PATIENT    │       │   FACILITY   │
├──────────────┤       ├──────────────┤       ├──────────────┤
│ id           │       │ id           │       │ id           │
│ email        │       │ userId       │───────│ name         │
│ phone        │       │ medicalId    │       │ address      │
│ passwordHash │       │ dateOfBirth  │       │ billingType  │
│ role         │◀──────│ facilityId   │──────▶│ contractId   │
│ status       │       │ loyaltyId    │       │              │
└──────┬───────┘       └──────┬───────┘       └──────────────┘
       │                      │
       │                      │
       ▼                      ▼
┌──────────────┐       ┌──────────────┐       ┌──────────────┐
│    DRIVER    │       │    TRIP      │       │   VEHICLE    │
├──────────────┤       ├──────────────┤       ├──────────────┤
│ id           │       │ id           │       │ id           │
│ userId       │──────▶│ tripNumber   │       │ make         │
│ licenseNum   │       │ patientId    │◀──────│ model        │
│ vehicleId    │──────▶│ driverId     │       │ type         │
│ status       │       │ vehicleId    │◀──────│ licensePlate │
│ rating       │       │ status       │       │ driverId     │
└──────────────┘       │ price        │       └──────────────┘
                       │ pickupAddr   │
                       │ dropoffAddr  │
                       └──────┬───────┘
                              │
              ┌───────────────┼───────────────┐
              │               │               │
              ▼               ▼               ▼
       ┌──────────────┐┌──────────────┐┌──────────────┐
       │  TRIP_STOP   ││   PAYMENT    ││  TRIP_LOG    │
       ├──────────────┤├──────────────┤├──────────────┤
       │ tripId       ││ tripId       ││ tripId       │
       │ stopOrder    ││ amount       ││ status       │
       │ type         ││ status       ││ timestamp    │
       │ address      ││ stripeId     ││ location     │
       │ status       ││              ││              │
       └──────────────┘└──────────────┘└──────────────┘
```

### 4.2 Supporting Entities

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                      SUPPORTING ENTITIES                                     │
└─────────────────────────────────────────────────────────────────────────────┘

┌──────────────────┐    ┌──────────────────┐    ┌──────────────────┐
│ STANDING_ORDER   │    │  HOLIDAY_CAL     │    │ SERVICE_CONFIG   │
├──────────────────┤    ├──────────────────┤    ├──────────────────┤
│ id               │    │ id               │    │ id               │
│ facilityId       │    │ date             │    │ region           │
│ patientId        │    │ name             │    │ startHour        │
│ daysOfWeek[]     │    │ multiplier       │    │ endHour          │
│ pickupTime       │    │ isClosed         │    │ minLeadTime      │
│ isActive         │    │                  │    │ serviceArea      │
└──────────────────┘    └──────────────────┘    └──────────────────┘

┌──────────────────┐    ┌──────────────────┐    ┌──────────────────┐
│ DRIVER_DOCUMENT  │    │   VEHICLE_DOC    │    │ MAINTENANCE_REC  │
├──────────────────┤    ├──────────────────┤    ├──────────────────┤
│ driverId         │    │ vehicleId        │    │ vehicleId        │
│ type             │    │ type             │    │ type             │
│ fileUrl          │    │ fileUrl          │    │ cost             │
│ expiryDate       │    │ expiryDate       │    │ date             │
│ verified         │    │ verified         │    │ notes            │
└──────────────────┘    └──────────────────┘    └──────────────────┘

┌──────────────────┐    ┌──────────────────┐    ┌──────────────────┐
│   AUDIT_LOG      │    │   CALL_LOG       │    │  SHIFT_NOTE      │
├──────────────────┤    ├──────────────────┤    ├──────────────────┤
│ userId           │    │ dispatcherId     │    │ dispatcherId     │
│ action           │    │ callerPhone      │    │ shiftDate        │
│ entityType       │    │ callType         │    │ shiftType        │
│ entityId         │    │ outcome          │    │ notes            │
│ timestamp        │    │ tripCreated      │    │ urgentItems      │
└──────────────────┘    └──────────────────┘    └──────────────────┘
```

### 4.3 Entity Relationships

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                      ENTITY RELATIONSHIPS                                    │
└─────────────────────────────────────────────────────────────────────────────┘

                                    ┌─────────┐
                                    │  USER   │
                                    └────┬────┘
                                         │
           ┌──────────────┬──────────────┼──────────────┬──────────────┐
           │              │              │              │              │
           ▼              ▼              ▼              ▼              ▼
      ┌─────────┐   ┌─────────┐   ┌─────────┐   ┌─────────┐   ┌─────────┐
      │ PATIENT │   │ DRIVER  │   │ FACILITY│   │  ADMIN  │   │ FAMILY  │
      │         │   │         │   │  STAFF  │   │         │   │ MEMBER  │
      └────┬────┘   └────┬────┘   └────┬────┘   └─────────┘   └────┬────┘
           │              │              │                          │
           │              │              │         ┌────────────────┘
           │              │              │         │ manages
           │              │              │         ▼
           │              │              │    ┌─────────┐
           │              │              └───▶│FACILITY │
           │              │                   └────┬────┘
           │              │                        │
           │              │         ┌──────────────┤
           │              │         │              │
           │              ▼         ▼              ▼
           │         ┌─────────┐  ┌─────────┐ ┌─────────┐
           │         │ VEHICLE │  │STANDING │ │CONTRACT │
           │         │         │  │ ORDER   │ │  RATE   │
           │         └────┬────┘  └────┬────┘ └─────────┘
           │              │            │
           │              │            │
           ▼              ▼            ▼
      ┌───────────────────────────────────────┐
      │                 TRIP                   │
      ├───────────────────────────────────────┤
      │  patientId  │  driverId  │  vehicleId │
      └───────────────────────────────────────┘
                          │
          ┌───────────────┼───────────────┐
          │               │               │
          ▼               ▼               ▼
     ┌─────────┐    ┌─────────┐    ┌─────────┐
     │TRIP_STOP│    │ PAYMENT │    │TRIP_LOG │
     └─────────┘    └─────────┘    └─────────┘
```

---

## 5. Integration Architecture

### 5.1 External Service Integration

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                     EXTERNAL INTEGRATIONS                                    │
└─────────────────────────────────────────────────────────────────────────────┘

                              ┌─────────────────┐
                              │   APPLICATION   │
                              │     SERVER      │
                              └────────┬────────┘
                                       │
       ┌───────────────┬───────────────┼───────────────┬───────────────┐
       │               │               │               │               │
       ▼               ▼               ▼               ▼               ▼
┌─────────────┐ ┌─────────────┐ ┌─────────────┐ ┌─────────────┐ ┌─────────────┐
│   STRIPE    │ │   TWILIO    │ │  SENDGRID   │ │   GOOGLE    │ │ QUICKBOOKS  │
├─────────────┤ ├─────────────┤ ├─────────────┤ ├─────────────┤ ├─────────────┤
│             │ │             │ │             │ │             │ │             │
│ • Payments  │ │ • SMS Send  │ │ • Email     │ │ • Places    │ │ • Invoices  │
│ • Refunds   │ │ • SMS Recv  │ │ • Templates │ │ • Geocode   │ │ • Customers │
│ • Connect   │ │ • Verify    │ │ • Tracking  │ │ • Directions│ │ • Payments  │
│ • Invoices  │ │ • Lookup    │ │             │ │ • Distance  │ │             │
│             │ │             │ │             │ │             │ │             │
└──────┬──────┘ └──────┬──────┘ └──────┬──────┘ └──────┬──────┘ └──────┬──────┘
       │               │               │               │               │
       │               │               │               │               │
       ▼               ▼               ▼               ▼               ▼
┌─────────────┐ ┌─────────────┐ ┌─────────────┐ ┌─────────────┐ ┌─────────────┐
│  Webhooks   │ │  Webhooks   │ │  Webhooks   │ │   Direct    │ │   OAuth     │
│             │ │             │ │             │ │   API       │ │   + API     │
│/webhooks/   │ │/webhooks/   │ │/webhooks/   │ │             │ │             │
│  stripe     │ │  twilio     │ │  sendgrid   │ │             │ │             │
└─────────────┘ └─────────────┘ └─────────────┘ └─────────────┘ └─────────────┘
```

### 5.2 Webhook Processing

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                       WEBHOOK PROCESSING                                     │
└─────────────────────────────────────────────────────────────────────────────┘

External Service                    Our Server                      Database
───────────────                    ──────────                       ────────

┌───────────────┐
│ Event Occurs  │
│ (e.g., payment│
│  succeeded)   │
└───────┬───────┘
        │
        │  POST /webhooks/stripe
        │  + Signature Header
        ▼
                              ┌─────────────────┐
                              │ Verify Signature│
                              │ (using secret)  │
                              └────────┬────────┘
                                       │
                              ┌────────▼────────┐
                              │  Parse Event    │
                              │  Type & Data    │
                              └────────┬────────┘
                                       │
                    ┌──────────────────┼──────────────────┐
                    │                  │                  │
                    ▼                  ▼                  ▼
           ┌───────────────┐  ┌───────────────┐  ┌───────────────┐
           │payment_intent │  │ invoice.paid  │  │ payout.paid   │
           │  .succeeded   │  │               │  │               │
           └───────┬───────┘  └───────┬───────┘  └───────┬───────┘
                   │                  │                  │
                   ▼                  ▼                  ▼
           ┌───────────────┐  ┌───────────────┐  ┌───────────────┐
           │ Update Trip   │  │ Update Invoice│  │ Update Driver │
           │ Payment       │  │ Status        │  │ Payout        │
           │ Status        │  │               │  │ Status        │
           └───────┬───────┘  └───────┬───────┘  └───────┬───────┘
                   │                  │                  │
                   └──────────────────┼──────────────────┘
                                      │
                                      ▼
                              ┌───────────────┐
                              │   Database    │
                              └───────────────┘
```

---

## 6. Real-Time Architecture

### 6.1 WebSocket Architecture

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                     REAL-TIME ARCHITECTURE                                   │
└─────────────────────────────────────────────────────────────────────────────┘

  Clients                     Socket.io Server                    Redis
  ───────                     ────────────────                    ─────

┌─────────────┐
│ Dispatcher  │──┐
│   Client    │  │
└─────────────┘  │
                 │       ┌─────────────────────────┐
┌─────────────┐  │       │     Socket.io Server    │
│   Driver    │──┼──────▶│                         │
│   Client    │  │       │  ┌─────────────────┐    │     ┌─────────────┐
└─────────────┘  │       │  │   Connection    │    │     │             │
                 │       │  │    Handler      │◀───┼────▶│   Redis     │
┌─────────────┐  │       │  └────────┬────────┘    │     │   Pub/Sub   │
│  Patient    │──┤       │           │             │     │             │
│   Client    │  │       │  ┌────────▼────────┐    │     │  Adapter    │
└─────────────┘  │       │  │    Room         │    │     │             │
                 │       │  │    Manager      │    │     └─────────────┘
┌─────────────┐  │       │  └────────┬────────┘    │
│  Facility   │──┘       │           │             │
│   Client    │          │  ┌────────▼────────┐    │
└─────────────┘          │  │   Event         │    │
                         │  │   Handlers      │    │
                         │  └────────┬────────┘    │
                         │           │             │
                         └───────────┼─────────────┘
                                     │
                                     ▼
                         ┌───────────────────────┐
                         │     Event Types       │
                         ├───────────────────────┤
                         │ • driver_location     │
                         │ • trip_status         │
                         │ • new_assignment      │
                         │ • eta_update          │
                         │ • will_call_activated │
                         │ • emergency_alert     │
                         └───────────────────────┘
```

### 6.2 Location Tracking Flow

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                     LOCATION TRACKING FLOW                                   │
└─────────────────────────────────────────────────────────────────────────────┘

Driver Phone                Server                    Clients             Database
────────────                ──────                    ───────             ────────

┌───────────┐
│  GPS      │
│  Sensor   │
│  (10 sec) │
└─────┬─────┘
      │
      │  { lat, lng, heading, speed, timestamp }
      │
      ▼
              ┌─────────────────────────────┐
              │  POST /drivers/me/location  │
              └─────────────┬───────────────┘
                            │
              ┌─────────────▼───────────────┐
              │    Validate & Sanitize      │
              └─────────────┬───────────────┘
                            │
              ┌─────────────▼───────────────┐
              │   Store in Redis (Hot)      │
              │   driver:location:{id}      │
              │   TTL: 60 seconds           │
              └─────────────┬───────────────┘
                            │
              ┌─────────────▼───────────────┐
              │   If on trip:               │
              │   - Calculate new ETA       │
              │   - Check geofences         │
              └─────────────┬───────────────┘
                            │
              ┌─────────────▼───────────────┐
              │   Publish to Redis          │
              │   driver:{id}:location      │
              └─────────────┬───────────────┘
                            │
                            ▼
                                          ┌───────────────────┐
                                          │  Socket.io        │
                                          │  broadcasts to    │
                                          │  subscribed       │
                                          │  clients          │
                                          └───────────────────┘
                            │
              ┌─────────────▼───────────────┐
              │   Every 60 sec:             │
              │   Persist to PostgreSQL     │──────────────────▶  Location
              │   (DriverLocationLog)       │                     History
              └─────────────────────────────┘
```

---

## 7. Security Architecture

### 7.1 Authentication Flow

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                      AUTHENTICATION FLOW                                     │
└─────────────────────────────────────────────────────────────────────────────┘

                         ┌─────────────────┐
                         │   Login Page    │
                         └────────┬────────┘
                                  │
               ┌──────────────────┼──────────────────┐
               │                  │                  │
               ▼                  ▼                  ▼
      ┌───────────────┐  ┌───────────────┐  ┌───────────────┐
      │   Email/      │  │  Magic Link   │  │   Phone       │
      │   Password    │  │               │  │   OTP         │
      └───────┬───────┘  └───────┬───────┘  └───────┬───────┘
              │                  │                  │
              ▼                  ▼                  ▼
      ┌───────────────┐  ┌───────────────┐  ┌───────────────┐
      │ Verify with   │  │ Send email    │  │ Send SMS      │
      │ bcrypt        │  │ with token    │  │ with code     │
      └───────┬───────┘  └───────┬───────┘  └───────┬───────┘
              │                  │                  │
              │                  │                  │
              └──────────────────┼──────────────────┘
                                 │
                                 ▼
                        ┌───────────────────┐
                        │ Check Account     │
                        │ Lockout Status    │
                        └─────────┬─────────┘
                                  │
                         ┌────────┴────────┐
                         │                 │
                    ┌────▼────┐       ┌────▼────┐
                    │ Locked  │       │   OK    │
                    └────┬────┘       └────┬────┘
                         │                 │
                         ▼                 ▼
                   ┌──────────┐     ┌──────────────┐
                   │  Error   │     │ Check 2FA    │
                   │  Response│     │ Enabled?     │
                   └──────────┘     └──────┬───────┘
                                           │
                                  ┌────────┴────────┐
                                  │                 │
                             ┌────▼────┐       ┌────▼────┐
                             │   Yes   │       │   No    │
                             └────┬────┘       └────┬────┘
                                  │                 │
                                  ▼                 │
                        ┌───────────────┐          │
                        │ Require TOTP  │          │
                        │ Code          │          │
                        └───────┬───────┘          │
                                │                  │
                                └──────────────────┘
                                          │
                                          ▼
                                 ┌───────────────────┐
                                 │  Generate JWT     │
                                 │  + Refresh Token  │
                                 └─────────┬─────────┘
                                           │
                                           ▼
                                 ┌───────────────────┐
                                 │  Set Cookies      │
                                 │  Create Session   │
                                 └───────────────────┘
```

### 7.2 Authorization Flow

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                      AUTHORIZATION FLOW                                      │
└─────────────────────────────────────────────────────────────────────────────┘

┌──────────────┐    ┌──────────────┐    ┌──────────────┐    ┌──────────────┐
│   Request    │───▶│  Extract     │───▶│   Verify     │───▶│   Check      │
│   Arrives    │    │   JWT        │    │   Token      │    │   Expiry     │
└──────────────┘    └──────────────┘    └──────────────┘    └──────┬───────┘
                                                                   │
                                                          ┌────────┴────────┐
                                                          │                 │
                                                     ┌────▼────┐       ┌────▼────┐
                                                     │ Expired │       │  Valid  │
                                                     └────┬────┘       └────┬────┘
                                                          │                 │
                                                          ▼                 ▼
                                                   ┌───────────┐    ┌───────────────┐
                                                   │  Try      │    │  Decode       │
                                                   │  Refresh  │    │  User Info    │
                                                   └─────┬─────┘    └───────┬───────┘
                                                         │                  │
                                                         ▼                  ▼
                                                                   ┌───────────────┐
                                                                   │  Get User     │
                                                                   │  Role         │
                                                                   └───────┬───────┘
                                                                           │
                                                                           ▼
                                                                   ┌───────────────┐
                                                                   │  Check Route  │
                                                                   │  Permission   │
                                                                   └───────┬───────┘
                                                                           │
                                                                  ┌────────┴────────┐
                                                                  │                 │
                                                             ┌────▼────┐       ┌────▼────┐
                                                             │ Denied  │       │Allowed │
                                                             └────┬────┘       └────┬────┘
                                                                  │                 │
                                                                  ▼                 ▼
                                                           ┌───────────┐    ┌───────────┐
                                                           │   403     │    │  Execute  │
                                                           │ Forbidden │    │  Handler  │
                                                           └───────────┘    └───────────┘
```

---

## Summary

This architecture document provides:

1. **High-Level Overview** - How all components connect
2. **Data Flows** - Step-by-step process for key operations
3. **Component Structure** - Frontend and backend organization
4. **Database Design** - Entity relationships
5. **Integrations** - External service connections
6. **Real-Time** - WebSocket and location tracking
7. **Security** - Auth and authorization flows

Use these diagrams as reference when implementing each feature.

---

*All diagrams are rendered using ASCII art for maximum compatibility.*
