# Autonomous Development Workflow
# 
# This workflow runs the AI development orchestrator on a schedule
# or when manually triggered.

name: ü§ñ Autonomous Development

on:
  # Run every 2 hours (adjust as needed)
  schedule:
    - cron: '0 */2 * * *'
  
  # Manual trigger with options
  workflow_dispatch:
    inputs:
      mode:
        description: 'Execution mode'
        required: true
        default: 'next'
        type: choice
        options:
          - next          # Run single task
          - continuous    # Run until checkpoint/complete
          - status        # Just show status
      max_tasks:
        description: 'Max tasks to run (continuous mode)'
        required: false
        default: '5'
        type: string

# Prevent concurrent runs
concurrency:
  group: autonomous-dev
  cancel-in-progress: false

env:
  NODE_VERSION: '20'

jobs:
  develop:
    name: üèóÔ∏è Run Development Task
    runs-on: ubuntu-latest
    timeout-minutes: 30
    
    # Only run if not awaiting checkpoint
    # (We check this in the script, but this prevents unnecessary runs)
    
    steps:
      - name: üì• Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for proper commits
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: üì¶ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: üìö Install dependencies
        run: npm ci

      - name: üóÑÔ∏è Generate Prisma client
        run: npx prisma generate

      - name: üìã Parse tasks (if needed)
        run: |
          if [ ! -f scripts/tasks/tasks.json ]; then
            npm run parse-tasks
          fi

      - name: üîç Check current status
        id: status
        run: |
          if [ -f scripts/tasks/progress.json ]; then
            AWAITING=$(cat scripts/tasks/progress.json | jq -r '.awaitingCheckpoint')
            CURRENT_DAY=$(cat scripts/tasks/progress.json | jq -r '.currentDay')
            COMPLETED=$(cat scripts/tasks/progress.json | jq -r '.tasksCompleted')
            echo "awaiting=$AWAITING" >> $GITHUB_OUTPUT
            echo "day=$CURRENT_DAY" >> $GITHUB_OUTPUT
            echo "completed=$COMPLETED" >> $GITHUB_OUTPUT
          else
            echo "awaiting=false" >> $GITHUB_OUTPUT
            echo "day=0" >> $GITHUB_OUTPUT
            echo "completed=0" >> $GITHUB_OUTPUT
          fi

      - name: ‚è∏Ô∏è Skip if awaiting checkpoint
        if: steps.status.outputs.awaiting == 'true'
        run: |
          echo "‚è∏Ô∏è Awaiting human checkpoint approval at Day ${{ steps.status.outputs.day }}"
          echo "Run 'npm run approve-checkpoint' locally and push to continue."
          exit 0

      - name: ü§ñ Run orchestrator
        if: steps.status.outputs.awaiting != 'true'
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
          # Add other secrets as needed
        run: |
          MODE="${{ github.event.inputs.mode || 'next' }}"
          
          if [ "$MODE" = "continuous" ]; then
            # Run multiple tasks with limit
            MAX_TASKS="${{ github.event.inputs.max_tasks || '5' }}"
            for i in $(seq 1 $MAX_TASKS); do
              echo "üîÑ Running task $i of $MAX_TASKS"
              npm run orchestrate || break
              sleep 10
            done
          else
            npm run orchestrate:$MODE
          fi

      - name: üìä Generate status report
        if: always()
        run: |
          echo "## ü§ñ Autonomous Development Status" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ -f scripts/tasks/progress.json ]; then
            CURRENT_DAY=$(cat scripts/tasks/progress.json | jq -r '.currentDay')
            COMPLETED=$(cat scripts/tasks/progress.json | jq -r '.tasksCompleted')
            FAILED=$(cat scripts/tasks/progress.json | jq -r '.tasksFailed')
            REMAINING=$(cat scripts/tasks/progress.json | jq -r '.tasksRemaining')
            PHASE=$(cat scripts/tasks/progress.json | jq -r '.currentPhase')
            AWAITING=$(cat scripts/tasks/progress.json | jq -r '.awaitingCheckpoint')
            
            echo "| Metric | Value |" >> $GITHUB_STEP_SUMMARY
            echo "|--------|-------|" >> $GITHUB_STEP_SUMMARY
            echo "| Current Day | $CURRENT_DAY / 100 |" >> $GITHUB_STEP_SUMMARY
            echo "| Phase | $PHASE |" >> $GITHUB_STEP_SUMMARY
            echo "| Tasks Completed | $COMPLETED |" >> $GITHUB_STEP_SUMMARY
            echo "| Tasks Failed | $FAILED |" >> $GITHUB_STEP_SUMMARY
            echo "| Tasks Remaining | $REMAINING |" >> $GITHUB_STEP_SUMMARY
            echo "| Awaiting Checkpoint | $AWAITING |" >> $GITHUB_STEP_SUMMARY
          else
            echo "No progress data available yet." >> $GITHUB_STEP_SUMMARY
          fi

      - name: üìù Commit changes
        if: steps.status.outputs.awaiting != 'true'
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "ü§ñ Autonomous development progress"
          commit_author: "AI Developer <ai@example.com>"
          file_pattern: |
            app/**
            components/**
            lib/**
            prisma/**
            scripts/tasks/**
            *.ts
            *.tsx
            *.json
            *.css

      - name: üîî Notify on checkpoint
        if: steps.status.outputs.awaiting == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `üõë Checkpoint: Day ${process.env.DAY} Review Required`,
              body: `
              The autonomous development system has reached a checkpoint at Day ${process.env.DAY}.
              
              ## Progress
              - Tasks Completed: ${process.env.COMPLETED}
              
              ## Required Actions
              1. Review the code changes
              2. Run tests locally
              3. If approved, run: \`npm run approve-checkpoint\`
              4. Push the changes to continue
              
              ## To Continue
              \`\`\`bash
              git pull
              npm run approve-checkpoint
              git add scripts/tasks/progress.json
              git commit -m "Approve checkpoint Day ${process.env.DAY}"
              git push
              \`\`\`
              `,
              labels: ['autonomous-dev', 'checkpoint']
            });
        env:
          DAY: ${{ steps.status.outputs.day }}
          COMPLETED: ${{ steps.status.outputs.completed }}

  notify-failure:
    name: üìß Notify on Failure
    runs-on: ubuntu-latest
    needs: develop
    if: failure()
    
    steps:
      - name: Create issue on failure
        uses: actions/github-script@v7
        with:
          script: |
            const runUrl = `${process.env.GITHUB_SERVER_URL}/${process.env.GITHUB_REPOSITORY}/actions/runs/${process.env.GITHUB_RUN_ID}`;
            
            github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: '‚ùå Autonomous Development Failed',
              body: `
              The autonomous development workflow failed.
              
              [View workflow run](${runUrl})
              
              Please investigate and fix the issue.
              `,
              labels: ['autonomous-dev', 'bug']
            });
